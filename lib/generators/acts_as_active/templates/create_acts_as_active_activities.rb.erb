 class CreateActsAsActiveActivities < ActiveRecord::Migration[7.1]
  def change
    create_table :acts_as_active_activities do |t|
      t.string     :trackable_type, null: false
      t.bigint     :trackable_id,   null: false
      t.references :actor, polymorphic: true, null: true
      t.date       :occurred_on,    null: false
      t.integer    :count,          null: false, default: 0
<%
  adapter = @adapter_name.to_s
  choice  = @metadata_choice

  def pg?(name) = name =~ /PostgreSQL/i
  col_type =
    if choice == "jsonb" || (choice == "auto" && pg?(adapter))
      :jsonb
    elsif choice == "json"
      :json
    elsif choice == "auto"
      :json
    else
      nil
    end
%>

<% if col_type %>
      t.<%= col_type %> :metadata, null: false, default: {}
<% end %>
      t.timestamps
    end

    add_index :acts_as_active_activities,
              %i[trackable_type trackable_id occurred_on],
              unique: true, name: "idx_aaa_trackable_on_day"
<% if col_type == :jsonb && pg?(@adapter_name) %>
    add_index :acts_as_active_activities, :metadata, using: :gin
<% end %>

  end
end
